<?xml version="1.0" encoding="UTF-8"?>
<project name="mmdb" default="war" basedir=".">

	<property environment="env" />

	<property name="webxml" value="web.xml" />

	<property name="deploy" value="/var/lib/tomcat6/webapps" />

	<property name="war" value="${ant.project.name}.war" />
	
	<property name="debug" value="true" />
	
	<property name="deprecation" value="true" />
		
	<property name="version" value="v0.4.100#${env.BUILD_NUMBER}" />

	<path id="classpath">
		<pathelement path="build" />
		<pathelement path="src" />
		<pathelement location="lib/gwt-user.jar" />
		<pathelement location="lib/gwt-dev.jar" />
		<fileset dir="war/WEB-INF/lib">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<target name="clean" description="deletes all generated files">
		<delete dir="war/mmdb" />
		<delete dir="war/WEB-INF/classes" />
		<delete dir="build" />
	</target>

	<target name="hudson" depends="tupeloidsa, cetbean, update_version, war, checkstyle" />

	<!-- copy the tupelo jar files -->
	<target name="tupeloidsa" description="Copy the latest tupelo jar on hudson">
		<delete  dir="war/WEB-INF/lib" includes="**/tupelo*.jar"/>
		<copy todir="war/WEB-INF/lib" preservelastmodified="true" overwrite="true" verbose="true" flatten="true">
			<fileset dir="/home/hudson/work/jobs/Tupelo 2.5/lastSuccessful">
				<include name="**/tupelo*.jar"/>
				<exclude name="**/tupelo*-2.5-tests.jar"/>
			</fileset>
		</copy>
	</target>
		
	<target name="tupeloshared" description="Copy the latest tupelo jar from shared">
		<delete  dir="war/WEB-INF/lib" includes="**/tupelo*.jar"/>
		<copy todir="war/WEB-INF/lib" preservelastmodified="true" overwrite="true" verbose="true" flatten="true">
			<fileset dir="\\isda\shared\build\tupelo\2.5">
				<include name="**/tupelo*.jar"/>
				<exclude name="**/*-2.5-tests.jar"/>
			</fileset>
		</copy>
	</target>

	<!-- make sure we have the latest beans -->
	<target name="cetbean" description="Compile CET beans.">
		<!-- compile the CET beans -->
		<delete dir="beanclass" />
		<mkdir dir="beanclass" />
		<javac destdir="beanclass" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.uiuc.ncsa.cet.bean/src" />
			<exclude name="**/sdl/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.uiuc.ncsa.cet.bean.jar">
			<fileset dir="beanclass" />
			<fileset dir="../edu.uiuc.ncsa.cet.bean/src">
				<exclude name="**/sdl/**/*.java" />
			</fileset>
		</jar>

		<!-- compile the CET beans tupelo -->
		<delete dir="beanclass" />
		<mkdir dir="beanclass" />
		<javac destdir="beanclass" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.uiuc.ncsa.cet.bean.tupelo/src" />
			<classpath>
				<fileset dir="war/WEB-INF/lib" includes="*.jar" />
			</classpath>
			<exclude name="**/sdl/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.uiuc.ncsa.cet.bean.tupelo.jar" basedir="beanclass" />

		<!-- compile the contexts 
		<delete dir="beanclass"/>
		<mkdir dir="beanclass"/>		
	    <javac destdir="beanclass" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
	    	<src path="../edu.uiuc.ncsa.cet.tupelo.contexts/src"/>
	    	<classpath>
	    		<fileset dir="war/WEB-INF/lib" includes="*.jar"/>
    		</classpath>
	    </javac>
		<jar jarfile="war/WEB-INF/lib/edu.uiuc.ncsa.cet.tupelo.contexts.jar" basedir="beanclass"/>
-->
		<!-- remove the temp folder -->
		<delete dir="beanclass" />
	</target>

	<!-- make sure we have the latest contexts jars -->
	<target name="contexts" depends="cetbean" description="Compile contexts jars">
		<delete dir="contextsTemp" />

		<!-- compile the mysql context jar -->
		<mkdir dir="contextsTemp" />
		<javac destdir="contextsTemp" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.illinois.ncsa.bard.context.mysql/src" />
			<classpath>
				<fileset dir="war/WEB-INF/lib" includes="*.jar" />
			</classpath>
			<exclude name="**/osgi/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.illinois.ncsa.bard.context.mysql.jar">
			<fileset dir="contextsTemp" />
			<fileset dir="../edu.illinois.ncsa.bard.context.mysql" includes="META-INF/services/*" />
		</jar>
		<delete dir="contextsTemp" />

		<!-- compile the tupeloserver context jar -->
		<mkdir dir="contextsTemp" />
		<javac destdir="contextsTemp" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.illinois.ncsa.bard.context.tupeloserver/src" />
			<classpath>
				<fileset dir="war/WEB-INF/lib" includes="*.jar" />
			</classpath>
			<exclude name="**/osgi/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.illinois.ncsa.bard.context.tupeloserver.jar">
			<fileset dir="contextsTemp" />
			<fileset dir="../edu.illinois.ncsa.bard.context.tupeloserver" includes="META-INF/services/*" />
		</jar>
		<delete dir="contextsTemp" />

	</target>

	<!-- make sure we have the latest jaas jars -->
	<target name="jaas" description="Compile jaas jars">
		<!-- compile the basic jaas jar -->
		<delete dir="jaasTemp" />
		<mkdir dir="jaasTemp" />
		<javac destdir="jaasTemp" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.illinois.ncsa.bard.jaas/src" />
			<classpath>
				<fileset dir="war/WEB-INF/lib" includes="*.jar" />
			</classpath>
			<exclude name="**/osgi/**/*.java" />
			<exclude name="edu/illinois/ncsa/bard/jaas/CETConfiguration.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.illinois.ncsa.bard.jaas.jar">
			<fileset dir="jaasTemp" />
			<fileset dir="../edu.illinois.ncsa.bard.jaas/src">
				<exclude name="**/osgi/**/*.java" />
				<exclude name="edu/illinois/ncsa/bard/jaas/CETConfiguration.java" />
			</fileset>
		</jar>

		<!-- compile the context based jaas module -->
		<delete dir="jaasTemp" />
		<mkdir dir="jaasTemp" />
		<javac destdir="jaasTemp" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.illinois.ncsa.bard.jaas.context/src" />
			<classpath>
				<fileset dir="war/WEB-INF/lib" includes="*.jar" />
			</classpath>
			<exclude name="**/osgi/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.illinois.ncsa.bard.jaas.context.jar">
			<fileset dir="jaasTemp" />
			<fileset dir="../edu.illinois.ncsa.bard.jaas.context/src">
				<exclude name="**/osgi/**/*.java" />
			</fileset>
		</jar>

		<!-- compile the always authenticate jaas module -->
		<delete dir="jaasTemp" />
		<mkdir dir="jaasTemp" />
		<javac destdir="jaasTemp" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<src path="../edu.illinois.ncsa.bard.jaas.always/src" />
			<exclude name="**/osgi/**/*.java" />
		</javac>
		<jar jarfile="war/WEB-INF/lib/edu.illinois.ncsa.bard.jaas.always.jar">
			<fileset dir="jaasTemp" />
			<fileset dir="../edu.illinois.ncsa.bard.jaas.always/src">
				<exclude name="**/osgi/**/*.java" />
			</fileset>
		</jar>
		<!-- delete temp directory -->
		<delete dir="jaasTemp" />
	</target>

	<target name="prepare-hudson" description="setup for hudson build and deployment">
		<property name="webxml" value="web-basic.xml" />
		<property name="buildtag" value="${env.BUILD_TAG}" />
		<available file="war/mmdb.tmp" property="mmdb_tmp_exists" />
	</target>

	<target name="checkstyle">
		<taskdef resource="checkstyletask.properties" classpath="/home/hudson/checkstyle/checkstyle-all-5.0-beta01.jar" />
		<checkstyle config="checks.xml" maxErrors="2147483647">
			<fileset dir=".">
				<include name="**/*.java" />
			</fileset>
			<formatter type="xml" toFile="checkstyle-result.xml" />
		</checkstyle>
	</target>

	<target name="update_version" depends="prepare-hudson, copy_mmdb_html" description="update the build version in MMDB.java">
		<copy file="war/mmdb.tmp" tofile="war/mmdb.html" overwrite="true">
			<filterset>
				<filter token="VERSION" value="${version}" />
			</filterset>
		</copy>
	</target>

	<target name="copy_mmdb_html" unless="mmdb_tmp_exists">
		<copy file="war/mmdb.html" tofile="war/mmdb.tmp" />
	</target>

	<target name="compile" depends="prepare" description="compiles Java source files to bytecode">
		<mkdir dir="war/WEB-INF/classes" />
		<javac srcdir="src" includes="**" encoding="utf-8" destdir="war/WEB-INF/classes" source="1.5" target="1.5" deprecation="${deprecation}" debug="${debug}">
			<classpath refid="classpath" />
		</javac>
	</target>

	<target name="gwtc" depends="compile" description="compiles Java source files to JavaScript">
		<!-- Consider adding -Xms256m -Xmx512m to improve performance. -->
		<java classname="com.google.gwt.dev.Compiler" classpathref="classpath" fork="true" failonerror="true">
			<jvmarg value="-Xms256m" />
			<jvmarg value="-Xmx512m" />
			<!-- <arg line="-style OBFUSCATE" /> -->
			<arg value="edu.illinois.ncsa.mmdb.web.MMDB" />
		</java>
	</target>

	<target name="resources" description="Copy all resources to output folder.">
		<copy todir="war/WEB-INF/classes">
			<fileset dir="src">
				<include name="commons-logging.properties" />
				<include name="configuration.xml" />
				<include name="jaas.config" />
				<include name="server.properties" />
			</fileset>
		</copy>
		<copy tofile="war/WEB-INF/classes/context.xml" file="src/context_mmdbdev_hfc.xml" />
		<copy tofile="war/WEB-INF/classes/log4j.properties" file="src/log4j_tomcat.properties" />
	</target>

	<target name="deploy" depends="war" description="deploys the war file to Tomcat">
		<copy file="build/${war}" todir="${deploy}" />
	</target>

	<target name="prepare" description="creates output directories">
		<mkdir dir="build" />
	</target>

	<target name="war" depends="clean, compile, gwtc, resources" description="builds the war file">
		<exec executable="./versions.sh" />
		<zip destfile="build/${war}" basedir="war" />
	</target>
</project>
