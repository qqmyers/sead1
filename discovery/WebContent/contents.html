<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Contents</title>
</head>
<link href="css/bootstrap.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-1.8.1.min.js"
	type="text/javascript"></script>
<script type="text/javascript">
	var abs = '';
	function roundNumber(num, dec) {
		var result = Math.round(num * Math.pow(10, dec)) / Math.pow(10, dec);
		return result;
	}

	$(function() {
		var url = window.location.href;
		var tagID = url.substring(url.indexOf("?") + 3, url.indexOf("&"));
		var title = url.substring(url.indexOf("&") + 3);
		$("#loading").show();
		$.ajax({
			type : "GET",
			url : "Contents",
			dataType : "json",
			data : "tagID=" + tagID + "&title=" + title,
			success : jsonParser
		});
		var displayTitle = decodeURIComponent(title);
		$("#pageheader").text(displayTitle);
		document.title = "Contents: " + displayTitle;

	});

	var div_html_collections = '';
	var div_html_datasets = '';
	var title = '';
	var length = '';
	var main_html = '';
	var uri = '';
	var displayTitle = '';
	var abs = '';

	function populateEntries(jsonBinding) {

		for ( var j = 0; j < jsonBinding.length; j++) {
			$.each(jsonBinding[j], function(key, value) {
				if (value == 'tagID') {
					uri = jsonBinding[j]['uri'];

				} else if (value == 'title') {
					title = jsonBinding[j]['literal'];
					displayTitle = title;

					if (title.indexOf("/") != -1) {
						displayTitle = title
								.substring(title.lastIndexOf("/") + 1);
					}

				} else if (value == 'length') {
					length = jsonBinding[j]['literal']['content'];

				}
				if (abs == '' && value == 'abstract') {
					abs = jsonBinding[j]['literal'];
				}
			});
		}

		if (uri.indexOf("Dataset") != -1) {
			urlToLoad = "http://sead.ncsa.illinois.edu/nced/#dataset?id=" + uri;
			div_html_datasets += "<tr><td align='center'><i class='icon-file'></i></td><td>"
					+ "<a href='" + urlToLoad
+ "' target='_blank'>"
					+ displayTitle
					+ "</a></td><td>"
					+ roundNumber((length / 1024), 2) + " KB</td></tr>";
		} else {
			urlToLoad = "contents.html?i=" + uri + "&t=" + displayTitle;
			div_html_collections += "<tr><td align='center'><i class='icon-folder-close'></i></td><td>"
					+ "<a href='" + urlToLoad
+ "'>"
					+ displayTitle
					+ "</a></td><td>N/A</td></tr>";
		}

		//This could be useful in future
		/* if (typeof obj == "object") {
			$.each(obj, function(k, v) {
				// k is either an array index or object key
				var str = jsonParser(v);
				console.log(str);

			});
		} else {
			return obj;
		} */

	}

	function jsonParser(jsonObj) {

		div_html_collections = '';
		div_html_datasets = '';
		title = '';
		length = '';
		main_html = '';
		uri = '';
		displayTitle = '';
		abs = '';

		/* var jsonString = JSON.stringify(json);
		var obj = jQuery.parseJSON(jsonString); */
		if (jsonObj.sparql.results.result != null) {
			if (jsonObj.sparql.results.result.length == null) {
				var jsonBinding = jsonObj.sparql.results.result.binding;
				populateEntries(jsonBinding);
			} else {
				for ( var i = 0; i < jsonObj.sparql.results.result.length; ++i) {

					var jsonBinding = jsonObj.sparql.results.result[i].binding;
					populateEntries(jsonBinding);
				}
			}
		}
		if (abs != "") {
			main_html = "<div class='well'><h3 style='margin-top:-5px;' class='page-header'>Abstract:</h3>"
					+ abs + "</div><br/>";
		}
		main_html += "<table class='table table-striped'><tbody><tr><th width='10'></th><th width='500'>File Name</th><th width='100'>Size</th></tr>"
				+ div_html_collections + div_html_datasets + "</tbody></table>";
		$("#loading").hide();
		$("#xmlBody").html(main_html);

	}

	/* function xmlParser(xml) {
		console.log(xml);
		var div_html_collections = '';
		var div_html_datasets = '';
		var title = '';
		var length = '';
		var main_html = '';
		var uri = '';
		$(xml)
				.find("result")
				.each(
						function() {
							var urlToLoad = "";
							if ($(this).find("binding").each(function() {
								if ($(this).attr("name") == "tagID") {
									uri = $(this).find("uri").text();
								} else if ($(this).attr("name") == "title") {
									title = $(this).find("literal").text();
								} else if ($(this).attr("name") == "length") {
									length = $(this).find("literal").text();
								} else if ($(this).attr("name") == "abstract") {
									abs = $(this).find("literal").text();
								}
							}))
								;
							if (uri.indexOf("Dataset") != -1) {
								urlToLoad = "http://sead.ncsa.illinois.edu/nced/#dataset?id="
										+ uri;
								div_html_datasets += "<tr><td><i class='icon-file'></i></td><td>"
										+ "<a href='" + urlToLoad
						+ "' target='_blank'>"
										+ title
										+ "</a></td><td>"
										+ roundNumber((length / 1024), 2)
										+ " KB</td></tr>";
							} else {
								urlToLoad = "contents.html?i=" + uri + "&t="
										+ title;
								div_html_collections += "<tr><td><i class='icon-folder-close'></i></td><td>"
										+ "<a href='" + urlToLoad
						+ "'>"
										+ title + "</a></td><td>N/A</td></tr>";
							}
						});
		if (abs != "") {
			main_html = "<div class='well'><h3 style='margin-top:-5px;' class='page-header'>Abstract:</h3>"
					+ abs + "</div><br/>";
		}
		main_html += "<table class='table table-striped'><tbody><tr><th width='10'></th><th width='500'>File Name</th><th width='100'>Size</th></tr>"
				+ div_html_collections + div_html_datasets + "</tbody></table>";
		$("#loading").hide();
		$("#xmlBody").html(main_html);

	} */
</script>

<body>
	<div class="page-header">
		<h1 style="margin-left: 20px;" id="pageheader"></h1>
	</div>
	<div id="loading"
		style="width: 300px; margin-left: auto; margin-right: auto; margin-top: 200px; display: none">
		<img src="img/loading.gif"></img>
	</div>
	<div
		style="width: auto; margin-top: 50px; margin-left: 100px; margin-right: 100px;"
		id="xmlBody"></div>
</body>
</html>